# History Hub

**History Hub** — это микросервис для сохранения истории диалогов пользователей и работы с ней. Сервис предоставляет API на базе FastAPI и использует Redis для хранения сообщений и поиска по векторным представлениям. Дополнительно поддерживается суммаризация и извлечение фактов при помощи Celery.
 Новая функция — автоматическая транскрибация аудио, поэтому загруженные голосовые сообщения сразу становятся доступными в текстовом виде.
## Возможности

- Сохранение сообщений разных типов (текст, изображение, аудио, видео и документы) с метаданными о размере и формате файла.
- Получение истории переписки и релевантного контекста.
- Суммаризация истории для быстрого восстановления контекста.
- Семантический поиск и фильтрация сообщений с помощью векторных эмбеддингов.
- Хранение пользовательских фактов, которые можно использовать при ответах.
- Поддержка фоновых задач (суммаризация и обновление фактов) через Celery.
- Автоматическая транскрибация аудио сообщений при их добавлении.
- Возможность групповых чатов с хранением участников.
- Автопоиск напоминаний в сообщениях и ведение календаря.
- Автоматическая расстановка тегов для сообщений и поиск по ним.
- Ассистент календаря для управления событиями через ИИ.
- Опциональное шифрование и сжатие сообщений.
- Учёт статистики использования и расчёт стоимости.
- Утилита `cli.py` для быстрого взаимодействия с API из командной строки.

## Преимущества перед простой историей

History Hub не просто хранит сообщения. Благодаря суммаризации, извлечению фактов и семантическому поиску сервис позволяет быстро восстанавливать контекст и строить более умных ассистентов, чем при простой линейной истории.

## Технологический стек

- **FastAPI** — API-сервер.
- **Redis** — хранилище сообщений и векторных данных.
- **Celery** — фоновые задачи суммаризации и обработки фактов.
- **MinIO** — S3-совместимое хранилище файлов.
- **SentenceTransformers** — генерация эмбеддингов для поиска.
- **OpenAI API** (опционально) — создание кратких пересказов.


## Быстрый старт

Самый простой способ запустить сервис — использовать `docker-compose`:

```bash
docker-compose up --build
```

После запуска API будет доступно по адресу `http://localhost:8000`. Дополнительно поднимаются Redis и MinIO для хранения данных и файлов.
Swagger UI можно открыть на `http://localhost:8000/docs` и авторизоваться через кнопку **Authorize**, указав токен в формате `Bearer <TOKEN>`.

Для запуска фоновых задач требуется отдельный воркер Celery c планировщиком:

```bash
docker-compose run --rm worker
```

## Основные переменные окружения

Переменные описаны в `app/config.py` и могут задаваться через `.env`:

- `REDIS_URL` — адрес Redis (по умолчанию `redis://redis:6379/0`).
- `MINIO_ENDPOINT` — адрес MinIO (`localhost:9000`).
- `MINIO_ACCESS_KEY` / `MINIO_SECRET_KEY` — учётные данные для MinIO.
- `MINIO_BUCKET` — имя бакета для хранения файлов (`history`).
- `OPENAI_API_KEY` — ключ OpenAI для суммаризации (опционально).
- `OPENAI_CHAT_MODEL` — модель ChatGPT для запросов (например `gpt-3.5-turbo`).
- `OPENAI_BASE_URL` — адрес совместимого API (`https://api.openai.com/v1` по умолчанию).
- `SUMMARY_TOKEN_THRESHOLD` — порог длины истории для автоматической суммаризации.
- `HF_EMBED_MODEL` — модель Sentence Transformers для получения эмбеддингов.
- `STT_WS_URL` — ws адрес сервера транскрибации
- `ENCRYPTION_KEY` — ключ для шифрования сообщений (если не задан, шифрование отключено).
- `ADMIN_KEY` — секрет для регистрации пользователей и компаний. Передается в заголовке `X-Admin-Key` при вызове `/register` и `/register_company`.
- `TOKEN_TTL` — время жизни токена в секундах (по умолчанию 86400).
- `REDIS_INDEX_ALGORITHM` — алгоритм индексации вектора (`flat` или `hnsw`, по умолчанию `flat`).
- `LOG_LEVEL` — уровень логирования (`INFO`, `DEBUG` и т.д.).
- `NOTIFICATION_SERVICE` — какой сервис использовать для уведомлений (`stub` по умолчанию).
- `COMPRESSION_THRESHOLD` — размер текста, начиная с которого он будет сжиматься.
- `COMPRESSION_ALGORITHM` — алгоритм сжатия сообщений (`gzip` по умолчанию).
- `COST_PER_MESSAGE` — стоимость одного пользовательского сообщения.
- `COST_PER_TOKEN` — стоимость обработки токена моделью.

## Используемые ключи Redis

- `facts:last:{uuid}` — ID последнего обработанного сообщения для извлечения фактов.
- `summary:last:{uuid}` — ID последней учтённой записи при суммаризации.
- `calendar:last:{stream}` — позиция последней проверки календаря для потока.

## Регистрация компании и управление пользователями

Перед использованием API необходимо создать компанию, а затем завести учетные записи сотрудников.

### Регистрация компании

```bash
curl -X POST http://localhost:8000/register_company \
  -H "Content-Type: application/json" \
  -H "X-Admin-Key: <ADMIN_KEY>" \
  -d '{"name": "mycorp", "password": "secret"}'
```

Ответ содержит токен компании. С ним можно получить доступ к панели управления.
При регистрации можно указать флаги `enable_summary`, `enable_facts` и
`enable_calendar` (по умолчанию включены), управляющие доступными возможностями.

### Создание пользователя

```bash
curl -X POST http://localhost:8000/register \
  -H "Content-Type: application/json" \
  -H "X-Admin-Key: <ADMIN_KEY>" \
  -d '{"username": "user1", "password": "pass", "company_id": "mycorp"}'
```

После регистрации пользователю возвращается собственный токен для обращения к API.

### Просмотр панели компании

```bash
curl http://localhost:8000/company/dashboard \
  -H "Authorization: Bearer <COMPANY_TOKEN>"
```

Страница отобразит список пользователей компании и статистику использования, а также вычисленную стоимость использования.

## API

- `POST /register` — создать нового пользователя и получить токен.
- `POST /login` — получить токен для существующего пользователя.
- `POST /register_company` — зарегистрировать новую компанию и получить токен.
- `POST /login_company` — авторизовать компанию и получить токен.
- `PUT /company/flags` — обновить настройки функций компании.
- `GET /company/dashboard` — HTML страница со списком пользователей и статистикой компании (требуется токен компании).
- `POST /add` — добавить список сообщений пользователя.
- `GET /history` — получить недавнюю историю переписки.
- `GET /context` — историю вместе с релевантными сообщениями, фактами и текущей суммаризацией.
- `POST /summary` — принудительно создать краткое содержание всей истории.
- `POST /search` — семантический поиск по истории.
- `POST /filter` — отфильтровать сообщения, опционально удаляя нерелевантные.
- `GET /search_by_tag` — получить сообщения с указанным тегом.
- `POST /reminder` — поставить напоминание на указанное время. Дополнительный параметр `tz` позволяет указать таймзону (по умолчанию `UTC`).
- `GET /calendar` — список запланированных напоминаний пользователя.
- `PUT /calendar/{index}` — изменить текст или время напоминания.
- `DELETE /calendar/{index}` — удалить событие из календаря.
- `GET /facts` — список сохранённых фактов пользователя.
- `DELETE /facts` — удалить факт пользователя.
- `POST /calendar/assistant` — диалоговый режим управления календарём.

Пример использования API можно посмотреть в файле [`ex.py`](ex.py), который демонстрирует полный сценарий взаимодействия.

### Пример запросов

Регистрация пользователя:

```bash
curl -X POST http://localhost:8000/register \
  -H "Content-Type: application/json" \
  -H "X-Admin-Key: <ADMIN_KEY>" \
  -d '{"username": "user1", "password": "pass", "company_id": "c1"}'
```

Добавление сообщений для пользователя:

```bash
curl -X POST http://localhost:8000/add \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <TOKEN>" \
  -d '{"uuid": "123", "messages": [{"role": "user", "content": "Привет"}]}'
```

Получение последних сообщений:

```bash
curl "http://localhost:8000/history?uuid=123&limit=5" \
  -H "Authorization: Bearer <TOKEN>"
```

### Пример загрузки аудио

```bash
curl -X POST http://localhost:8000/add \
  -H "Content-Type: multipart/form-data" \
  -F "uuid=123" \
  -F "messages[0].role=user" \
  -F "messages[0].type=audio" \
  -F "messages[0].extra[file]=@voice.ogg"
```

Файл будет сохранён в хранилище, а его текстовая версия появится в истории автоматически.

### Работа с напоминаниями

```bash
curl -X POST "http://localhost:8000/reminder?uuid=123&when=2024-01-01T09:00:00&text=%D0%A1%D0%B4%D0%B0%D1%82%D1%8C%20%D0%BE%D1%82%D1%87%D1%91%D1%82" \
  -H "Authorization: Bearer <TOKEN>"

curl "http://localhost:8000/calendar?uuid=123" \
  -H "Authorization: Bearer <TOKEN>"

curl -X PUT http://localhost:8000/calendar/0 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <TOKEN>" \
  -d '{"uuid": "123", "text": "Новый текст"}'

curl -X DELETE http://localhost:8000/calendar/0 \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <TOKEN>" \
  -d '{"uuid": "123"}'
```
## Структура проекта

- `app/` — основной код FastAPI‑приложения и утилиты работы с данными.
- `app/services/` — вспомогательные сервисы: `calendar.py`, `company.py`, `facts.py`, `llm.py`, `messages.py`.
- `worker/` — Celery worker с задачами для суммаризации и обновления фактов.
- `Dockerfile` и `docker-compose.yml` — файлы для контейнеризации и локального запуска.
- `requirements.txt` — зависимости Python.

Функции работы с фактами, календарём и проверкой компаний теперь находятся в
пакете `app/services` (`facts.py`, `calendar.py`, `company.py`).

## Запуск демонстрационного скрипта

```bash
python ex.py
```

Скрипт отправит серию сообщений, получит историю и распечатает суммаризацию.
## Использование CLI

Простейшие команды можно выполнить через `cli.py`:

```bash
python cli.py add 123 "Привет" --chat-id group1
python cli.py history 123 --chat-id group1
python cli.py reminder 123 2024-01-01T09:00:00 "Сдать отчёт" --token TOKEN
python cli.py calendar 123 --token TOKEN
python cli.py update 123 0 --text "Новый текст" --token TOKEN
python cli.py delete 123 0 --token TOKEN
```


## Лицензия

Код распространяется на условиях лицензии, разрешающей только некоммерческое
использование. Автор сохраняет исключительные права на коммерческое
использование.
