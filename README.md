# History Hub

**History Hub** — это микросервис для сохранения истории диалогов пользователей и работы с ней. Сервис предоставляет API на базе FastAPI и использует Redis для хранения сообщений и поиска по векторным представлениям. Дополнительно поддерживается суммаризация и извлечение фактов при помощи Celery.
 Новая функция — автоматическая транскрибация аудио, поэтому загруженные голосовые сообщения сразу становятся доступными в текстовом виде.
## Возможности

- Сохранение сообщений разных типов (текст, изображение, аудио) с метаданными.
- Получение истории переписки и релевантного контекста.
- Суммаризация истории для быстрого восстановления контекста.
- Семантический поиск и фильтрация сообщений с помощью векторных эмбеддингов.
- Хранение пользовательских фактов, которые можно использовать при ответах.
- Поддержка фоновых задач (суммаризация и обновление фактов) через Celery.
- Автоматическая транскрибация аудиосообщений при их добавлении.

## Быстрый старт

Самый простой способ запустить сервис — использовать `docker-compose`:

```bash
docker-compose up --build
```

После запуска API будет доступно по адресу `http://localhost:8000`. Дополнительно поднимаются Redis и MinIO для хранения данных и файлов.

Для запуска фоновых задач требуется отдельный воркер Celery:

```bash
docker-compose run --rm worker
```

## Основные переменные окружения

Переменные описаны в `app/config.py` и могут задаваться через `.env`:

- `REDIS_URL` — адрес Redis (по умолчанию `redis://redis:6379/0`).
- `MINIO_ENDPOINT` — адрес MinIO (`localhost:9000`).
- `MINIO_ACCESS_KEY` / `MINIO_SECRET_KEY` — учётные данные для MinIO.
- `MINIO_BUCKET` — имя бакета для хранения файлов (`history`).
- `OPENAI_API_KEY` — ключ OpenAI для суммаризации (опционально).
- `SUMMARY_TOKEN_THRESHOLD` — порог длины истории для автоматической суммаризации.
- `HF_EMBED_MODEL` — модель Sentence Transformers для получения эмбеддингов.

## API

- `POST /add` — добавить список сообщений пользователя.
- `GET /history` — получить недавнюю историю переписки.
- `GET /context` — историю вместе с релевантными сообщениями, фактами и текущей суммаризацией.
- `POST /summary` — принудительно создать краткое содержание всей истории.
- `POST /search` — семантический поиск по истории.
- `POST /filter` — отфильтровать сообщения, опционально удаляя нерелевантные.

Пример использования API можно посмотреть в файле [`ex.py`](ex.py), который демонстрирует полный сценарий взаимодействия.

### Пример запросов

Добавление сообщений для пользователя:

```bash
curl -X POST http://localhost:8000/add \
  -H "Content-Type: application/json" \
  -d '{"uuid": "123", "messages": [{"role": "user", "content": "Привет"}]}'
```

Получение последних сообщений:

```bash
curl "http://localhost:8000/history?uuid=123&limit=5"
```

### Пример загрузки аудио

```bash
curl -X POST http://localhost:8000/add \
  -H "Content-Type: multipart/form-data" \
  -F "uuid=123" \
  -F "messages[0].role=user" \
  -F "messages[0].type=audio" \
  -F "messages[0].extra[file]=@voice.ogg"
```

Файл будет сохранён в хранилище, а его текстовая версия появится в истории автоматически.
## Структура проекта

- `app/` — основной код FastAPI-приложения и утилиты работы с данными.
- `worker/` — Celery worker с задачами для суммаризации и обновления фактов.
- `Dockerfile` и `docker-compose.yml` — файлы для контейнеризации и локального запуска.
- `requirements.txt` — зависимости Python.

## Запуск демонстрационного скрипта

```bash
python ex.py
```

Скрипт отправит серию сообщений, получит историю и распечатает суммаризацию.

## Лицензия

Проект распространяется на условиях MIT License.